from lshash import LSHash
from utils.db_utils import postgres_db
import json
import time

import numpy as np   # 数据处理的库 numpy
import cv2           # 图像处理的库 OpenCv
import json
import time

from utils.db_utils import postgres_db, get_known_id_name_encoding, get_name_from_txt


known_face_id, known_face_names, known_face_encodings, known_face_tmp_id = get_known_id_name_encoding()
def get_name_id(face_encodings):
    """
    服务器端工作: 接受摄像头内所有的人脸, 与数据库中的人脸进行对比
    :param face_encodings: 一系列的位置人脸encoding的列表
    :return: 返回所有人脸的id和名字
    """
    # 定义一个新的列表, 储存识别出来的脸对应人名
    face_names = []
    face_id = []
    face_temp_id = []

    for encoding in face_encodings:
        # 默认当前人脸为unknow, _id 为 none
        name, _id = 'Unknown', None

        # 遍历人脸, 获取与已知的encoding的欧氏距离, 获取最佳match
        distances = face_distance(known_face_encodings, encoding)

        best_match_index = np.argmin(distances)
        min_distance = distances[best_match_index]
        # 判断是否同一人的欧氏距离阈值, 如果是则更改name 和 _id
        if min_distance < 0.4:
            name = known_face_names[best_match_index]
            _id = known_face_id[best_match_index]
            temp_id = known_face_tmp_id[best_match_index]
        face_names.append(name)
        face_id.append(_id)
        face_temp_id.append(temp_id)
    return face_names, face_id, face_temp_id

def face_distance(known_encodings, encoding):
    """
    计算encoding与known_encodings的Euclidean距离
    :param known_encodings: 已知的所有脸的encoding
    :param encoding: 给定的未知的encoding
    :return: 返回一个列表, 每个元素是与encoding的欧氏距离
    """
    if len(encoding) == 0:
        return np.empty((0))
    return np.linalg.norm(known_encodings - encoding, axis=1)


def demo2(encodings):
    m_test_str = encodings[0]
    lsh = LSHash(30, 128)
    results = postgres_db.get_record()
    for i in range(10):
        for re in results:
            encoding = json.loads([re[2]][0])
            lsh.index(encoding)

    # m_test_str = [-0.06653771549463272, 0.11146444082260132, 0.12440238893032074, -0.03164754807949066, -0.07741986960172653, -0.052251528948545456, -0.0452718660235405, -0.12470222264528275, 0.13816797733306885, -0.1152077317237854, 0.30777010321617126, -0.05984947085380554, -0.22960340976715088, -0.06158236414194107, -0.0368158295750618, 0.13717320561408997, -0.1720796525478363, -0.054847318679094315, 0.03207693248987198, -0.016324982047080994, 0.09520047903060913, -0.05028649419546127, 0.06936555355787277, 0.01444101333618164, -0.10460524260997772, -0.4248502850532532, -0.16103540360927582, -0.12525387108325958, 0.03820095211267471, -0.07820531725883484, -0.07559949159622192, 0.041290223598480225, -0.18277162313461304, -0.04992262274026871, -0.04785884916782379, 0.03455768898129463, -0.02554512768983841, -0.09900963306427002, 0.19031216204166412, 0.026386963203549385, -0.12277176976203918, 0.029416918754577637, -0.04534045606851578, 0.2189793586730957, 0.12152285128831863, 0.05403172969818115, 0.11551205813884735, -0.10862165689468384, 0.06065893918275833, -0.11007172614336014, 0.05542479455471039, 0.11487678438425064, 0.06607837229967117, 0.0483563169836998, -0.01173054426908493, -0.1539774388074875, 0.026989340782165527, 0.04025784879922867, -0.19124165177345276, 0.04079391434788704, 0.08694103360176086, -0.09753528237342834, -0.05202677845954895, -0.0361427366733551, 0.2763848900794983, 0.11055128276348114, -0.09807266294956207, -0.10787709802389145, 0.1593283861875534, -0.09044744819402695, -0.014550719410181046, -0.013175759464502335, -0.1954842507839203, -0.17338010668754578, -0.2335323840379715, 0.09246896207332611, 0.36300235986709595, 0.09598186612129211, -0.17719700932502747, 0.053821999579668045, -0.11677977442741394, -0.012124978005886078, 0.10209283232688904, 0.1530897617340088, -0.008745644241571426, 0.05082784593105316, -0.08224072307348251, 0.0614226758480072, 0.1501639038324356, -0.09588664770126343, -0.04987918213009834, 0.21729464828968048, -0.050959691405296326, 0.10210547596216202, 0.04017883539199829, -0.01896556466817856, -0.093389593064785, 0.03875189274549484, -0.08343469351530075, 0.025276564061641693, 0.05463620275259018, -0.07922526448965073, -0.06038445234298706, 0.05905422568321228, -0.17931686341762543, 0.0898800939321518, -0.012743934988975525, -0.03877785801887512, -0.004718668758869171, -0.06470093131065369, -0.131295308470726, -0.04685156047344208, 0.13748934864997864, -0.28045785427093506, 0.23786547780036926, 0.2017388641834259, 0.052667610347270966, 0.1870713084936142, 0.09802237153053284, 0.07056915760040283, 0.02252197265625, -0.045353963971138, -0.19393855333328247, -0.017421327531337738, 0.11406006664037704, 0.008461438119411469, 0.0672500729560852, -0.012140557169914246]

    start_time = time.time()
    end_time = time.time()
    # for i in range(1000):
    result = lsh.query(m_test_str, distance_func='true_euclidean')
    found_encoding = json.dumps(list(result[0][0]))

    # found_encoding = 156024598550
    result = postgres_db.get_info_by_encoding(found_encoding)
    print(result)
    # result = postgres_db.get_info_by_id(6)
    # print(result)

    time_use = end_time-start_time
    print(time_use*10000000)




if __name__ == "__main__":
    encodings = np.array([[-0.06653771549463272, 0.11146444082260132, 0.12440238893, -0.03164754807949066, -0.07741986960172653, -0.052251528948545456, -0.0452718660235405, -0.12470222264528275, 0.13816797733306885, -0.1152077317237854, 0.30777010321617126, -0.05984947085380554, -0.22960340976715088, -0.06158236414194107, -0.0368158295750618, 0.13717320561408997, -0.1720796525478363, -0.054847318679094315, 0.03207693248987198, -0.016324982047080994, 0.09520047903060913, -0.05028649419546127, 0.06936555355787277, 0.01444101333618164, -0.10460524260997772, -0.4248502850532532, -0.16103540360927582, -0.12525387108325958, 0.03820095211267471, -0.07820531725883484, -0.07559949159622192, 0.041290223598480225, -0.18277162313461304, -0.04992262274026871, -0.04785884916782379, 0.03455768898129463, -0.02554512768983841, -0.09900963306427002, 0.19031216204166412, 0.026386963203549385, -0.12277176976203918, 0.029416918754577637, -0.04534045606851578, 0.2189793586730957, 0.12152285128831863, 0.05403172969818115, 0.11551205813884735, -0.10862165689468384, 0.06065893918275833, -0.11007172614336014, 0.05542479455471039, 0.11487678438425064, 0.06607837229967117, 0.0483563169836998, -0.01173054426908493, -0.1539774388074875, 0.026989340782165527, 0.04025784879922867, -0.19124165177345276, 0.04079391434788704, 0.08694103360176086, -0.09753528237342834, -0.05202677845954895, -0.0361427366733551, 0.2763848900794983, 0.11055128276348114, -0.09807266294956207, -0.10787709802389145, 0.1593283861875534, -0.09044744819402695, -0.014550719410181046, -0.013175759464502335, -0.1954842507839203, -0.17338010668754578, -0.2335323840379715, 0.09246896207332611, 0.36300235986709595, 0.09598186612129211, -0.17719700932502747, 0.053821999579668045, -0.11677977442741394, -0.012124978005886078, 0.10209283232688904, 0.1530897617340088, -0.008745644241571426, 0.05082784593105316, -0.08224072307348251, 0.0614226758480072, 0.1501639038324356, -0.09588664770126343, -0.04987918213009834, 0.21729464828968048, -0.050959691405296326, 0.10210547596216202, 0.04017883539199829, -0.01896556466817856, -0.093389593064785, 0.03875189274549484, -0.08343469351530075, 0.025276564061641693, 0.05463620275259018, -0.07922526448965073, -0.06038445234298706, 0.05905422568321228, -0.17931686341762543, 0.0898800939321518, -0.012743934988975525, -0.03877785801887512, -0.004718668758869171, -0.06470093131065369, -0.131295308470726, -0.04685156047344208, 0.13748934864997864, -0.28045785427093506, 0.23786547780036926, 0.2017388641834259, 0.052667610347270966, 0.1870713084936142, 0.09802237153053284, 0.07056915760040283, 0.02252197265625, -0.045353963971138, -0.19393855333328247, -0.017421327531337738, 0.11406006664037704, 0.008461438119411469, 0.0672500729560852, -0.012140557169914246], ])
    # encodings = np.array([[-0.12717530131340027, 0.06872853636741638, 0.08179943263530731, 0.013176612555980682, -0.09503861516714096, -0.08196950703859329, -0.051403455436229706, -0.0915319174528122, 0.14077764749526978, -0.009482508525252342, 0.26788899302482605, -0.020975198596715927, -0.20867682993412018, -0.17215465009212494, -0.003972873091697693, 0.16416075825691223, -0.13009755313396454, -0.11836547404527664, -0.059880055487155914, -0.06341136246919632, 0.061979301273822784, 0.046455513685941696, 0.09351547062397003, -0.02058955281972885, -0.14488118886947632, -0.42376112937927246, -0.03926325961947441, -0.10312163829803467, 0.021039336919784546, -0.03712156414985657, -0.009145956486463547, 0.1091756522655487, -0.15051282942295074, -0.06798839569091797, 0.07690386474132538, 0.11845752596855164, 0.01137525588274002, -0.03593837097287178, 0.1718195378780365, -0.02553662285208702, -0.23008310794830322, -0.04013839364051819, 0.029982633888721466, 0.2496514618396759, 0.19133809208869934, 0.0508095920085907, 0.06554662436246872, -0.07735331356525421, 0.0992165133357048, -0.16411399841308594, 0.03261806070804596, 0.13738484680652618, 0.06563989073038101, -0.0247032567858696, 0.039309434592723846, -0.10961887240409851, 0.04552909731864929, 0.09149322658777237, -0.2173960655927658, -0.01793212816119194, 0.054500989615917206, -0.15879788994789124, -0.08329319953918457, -0.008293502032756805, 0.22352203726768494, 0.10425275564193726, -0.09573318064212799, -0.15082517266273499, 0.11873839050531387, -0.12687553465366364, -0.0703478679060936, 0.04041879624128342, -0.18718263506889343, -0.14755329489707947, -0.3708004951477051, -0.014899447560310364, 0.4775996804237366, 0.017912868410348892, -0.20240095257759094, 0.0797768086194992, -0.01073446124792099, 0.035828493535518646, 0.12228807806968689, 0.1662643849849701, -0.07295060902833939, 0.01692754030227661, -0.1552443653345108, 0.008843347430229187, 0.16969522833824158, -0.06118679791688919, -0.09185432642698288, 0.15134942531585693, -0.019034206867218018, 0.09273044764995575, 0.05905219912528992, 0.03181018680334091, -0.05830773711204529, 0.01920958422124386, -0.06801381707191467, -0.05451669543981552, 0.13054659962654114, -0.029426977038383484, 0.03213457018136978, 0.08838701248168945, -0.1404508650302887, 0.096944160759449, -0.003167875111103058, 0.06104641407728195, 0.07107262313365936, -0.031523436307907104, -0.013469457626342773, -0.0855851098895073, 0.09214062988758087, -0.20271533727645874, 0.21845710277557373, 0.17651718854904175, 0.014520872384309769, 0.17357279360294342, 0.08019989728927612, 0.06103072315454483, -0.01251991093158722, 0.03681445121765137, -0.14724037051200867, -0.03923211246728897, 0.020990382879972458, -0.012743741273880005, 0.11311393976211548, 0.02206813544034958]])
    # start_time = time.time()
    # for i in range(1000):
    #     result = get_name_id(encodings)
    # print(result)
    # end_time = time.time()
    # print(end_time-start_time)

    # start_time = time.time()
    demo2(encodings)
    # end_time = time.time()
    # print(end_time-start_time)
